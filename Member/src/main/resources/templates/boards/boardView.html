<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${board != null ? board.bTitle + ' - 게시글 상세보기' : '게시글 상세보기'}">게시글 상세보기</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Tailwind CSS를 최대한 활용하므로, 꼭 필요한 최소한의 스타일만 남깁니다. */
    /* 예를 들어, .action-links 내 버튼 스타일은 유지할 수 있습니다. */
    .action-links a, .action-links button {
      display: inline-flex; /* 아이콘과 텍스트 정렬 */
      align-items: center;
      gap: 0.5rem; /* 아이콘과 텍스트 사이 간격 (space-x-2) */
      font-size: 0.9rem; /* text-sm 또는 text-base */
      font-weight: 500; /* font-medium */
      padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
      border-radius: 0.375rem; /* rounded-md */
      border: none;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.2s, transform 0.1s;
      color: white;
    }
    .action-links a { background-color: cornflowerblue; } /* bg-indigo-500 */
    .action-links button.delete { background-color: crimson; } /* bg-red-600 */
    .action-links button#like-button { background-color: #3498db; } /* bg-sky-500 */

    .action-links a:hover { background-color: royalblue; transform: translateY(-1px); } /* hover:bg-indigo-600 */
    .action-links button.delete:hover { background-color: darkred; transform: translateY(-1px); } /* hover:bg-red-700 */
    .action-links button#like-button:hover { background-color: #2980b9; transform: translateY(-1px); } /* hover:bg-sky-600 */

    /* 첨부파일 이미지 스타일 */
    .attachment-image {
      width: 180px;  /* w-[180px] */
      height: 135px; /* h-[135px] */
      object-fit: cover;
      border: 1px solid #e0e0e0; /* border border-gray-300 */
      border-radius: 0.5rem; /* rounded-lg */
      box-shadow: 0 4px 8px rgba(0,0,0,0.05); /* shadow-md */
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .attachment-image:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1); /* shadow-lg */
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
<div th:replace="~{fragments/header :: commonHeader}"></div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-20 sm:pt-24"> <div th:if="${board != null}" class="bg-white shadow-xl rounded-xl p-6 md:p-10 mb-8">
  <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4" th:text="${board.bTitle}">게시글 제목</h1>

  <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600 mb-6 p-4 bg-gray-50 rounded-md">
    <p class="flex items-center"><i class="fas fa-user mr-2 text-blue-500"></i> 작성자:
      <span class="font-medium text-gray-800 ml-1" th:text="${board.authorName}">작성자명</span>
      <span class="text-gray-500 ml-1" th:text="'(' + ${board.authorUid} + ')'"></span>
    </p>
    <p class="flex items-center"><i class="fas fa-clock mr-2 text-blue-500"></i> 작성일:
      <span class="font-medium text-gray-800 ml-1" th:text="${board.bDate != null ? #temporals.format(board.bDate, 'yyyy-MM-dd HH:mm') : ''}"></span>
    </p>
    <p class="flex items-center"><i class="fas fa-eye mr-2 text-blue-500"></i> 조회수:
      <span class="font-medium text-gray-800 ml-1" th:text="${board.viewCount}">0</span>
    </p>
  </div>

  <hr class="my-6 border-gray-200" />

  <div class="prose prose-lg max-w-none text-gray-700 mb-8 whitespace-pre-wrap" th:text="${board.bContent}">게시글 내용</div>

  <div th:if="${board.attachments != null and not #lists.isEmpty(board.attachments)}">
    <hr class="my-6 border-gray-200" />
    <div class="attachments-section mt-8 mb-8">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-paperclip mr-2 text-blue-500"></i> 첨부된 파일</h3>
      <div class="flex flex-wrap gap-4">
        <div th:each="att : ${board.attachments}" class="attachment-item">
          <a th:href="@{'/uploads/' + ${att.filePath}}" target="_blank" th:title="${att.fileName}">
            <img th:src="@{'/uploads/' + ${att.filePath}}" th:alt="${att.fileName}" class="attachment-image" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-6 border-gray-200" />

  <div class="action-links mt-8">
    <th:block th:if="${currentUserId != null and board.authorUid == currentUserId}">
      <a th:href="@{'/boards/' + ${board.bNo} + '/edit'}"><i class="fas fa-edit"></i> 수정</a>
      <form th:action="@{'/boards/' + ${board.bNo} + '/delete'}" method="post" class="inline" onsubmit="return confirm('정말로 이 게시글을 삭제하시겠습니까?');">
        <button type="submit" class="delete">
          <i class="fas fa-trash"></i> 삭제
        </button>
      </form>
    </th:block>

    <button type="button" id="like-button"
            th:attr="data-board-id=${board.bNo}, data-board-type=${defaultBoardType ?: 'board'}">
      <i class="fas fa-thumbs-up"></i>
      <span th:if="${likeStatus != null and likeStatus.currentUserLiked == true}">좋아요 취소</span>
      <span th:unless="${likeStatus != null and likeStatus.currentUserLiked == true}">좋아요</span>
      (<span id="like-count" th:text="${likeStatus != null ? likeStatus.totalLikeCount : board.likeCount}">0</span>)
    </button>

    <a th:href="@{/boards}"><i class="fas fa-list"></i> 목록으로</a>
  </div>
</div>

  <div th:unless="${board != null}" class="bg-white shadow-xl rounded-xl p-10 mb-8 text-center">
    <p class="text-xl text-gray-600">게시글을 찾을 수 없습니다.</p>
    <a th:href="@{/boards}" class="mt-4 inline-block px-6 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600">목록으로 돌아가기</a>
  </div>
</div>

<script th:inline="javascript">
  const defaultBoardTypeFromModel = /*[[${defaultBoardType}]]*/ 'board'; // 컨트롤러에서 전달한 기본 boardType

  document.addEventListener("DOMContentLoaded", () => {
    const likeButton = document.getElementById("like-button");

    if (likeButton) {
      likeButton.addEventListener("click", () => {
        const boardId = likeButton.dataset.boardId;
        const boardType = likeButton.dataset.boardType || defaultBoardTypeFromModel; // 버튼에 없으면 모델 값 사용
        const likeButtonTextSpan = likeButton.querySelector('span:not(#like-count)'); // 아이콘 제외 텍스트 부분
        const likeCountElement = document.getElementById("like-count");

        fetch(`/api/likes/${boardType}/${boardId}`, { // LikeController 경로 예시
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
            // CSRF 토큰 필요시 추가:
            // const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            // const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            // headers[csrfHeaderName] = csrfToken;
          }
        })
                .then(res => {
                  if (res.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = /*[[@{/login}]]*/ '/login'; // 실제 로그인 경로
                    throw new Error('로그인 필요');
                  }
                  if (!res.ok) {
                    return res.json().then(errData => {
                      throw new Error(errData.message || "좋아요 요청에 실패했습니다.");
                    }).catch(() => {
                      throw new Error(`좋아요 요청 실패 (상태 코드: ${res.status})`);
                    });
                  }
                  return res.json();
                })
                .then(data => {
                  if (data.success && data.likeCount !== undefined) {
                    likeCountElement.textContent = data.likeCount;
                    if (data.liked) { // 현재 좋아요를 누른 상태
                      likeButtonTextSpan.textContent = '좋아요 취소';
                    } else { // 현재 좋아요를 취소한 상태
                      likeButtonTextSpan.textContent = '좋아요';
                    }
                  } else if (data.message) {
                    alert(data.message);
                  }
                })
                .catch(err => {
                  if (err.message !== '로그인 필요') {
                    console.error("좋아요 에러:", err);
                    alert(err.message || '좋아요 처리 중 오류가 발생했습니다.');
                  }
                });
      });
    }
  });

</script>
</body>
</html>