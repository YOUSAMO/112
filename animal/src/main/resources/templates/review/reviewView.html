<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${review != null ? review.arTitle + ' - 입양 후기' : '입양 후기 상세보기'}"></title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* action-links, attachment-image 등 필요한 모든 스타일 추가 */
    .action-links a, .action-links button { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 500; padding: 0.625rem 1.25rem; border-radius: 0.375rem; border: none; cursor: pointer; text-decoration: none; text-align: center; transition: background-color 0.2s, transform 0.1s; color: white; }
    .action-links a.edit-action { background-color: #0ea5e9; }
    .action-links button.delete-action { background-color: #ef4444; }
    .action-links button#like-button { background-color: #3b82f6; }
    .action-links button#like-button.liked { background-color: #ec4899; }
    .action-links a.list-action { background-color: #64748b; }
    .action-links a:hover, .action-links button:hover { transform: translateY(-1px); opacity: 0.9; }
    .attachment-image { width: 180px; height: 135px; object-fit: cover; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s; }
    .attachment-image:hover { transform: scale(1.05); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div th:replace="~{fragments/header :: commonHeader}"></div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-20 sm:pt-24">
  <div th:if="${review != null}" class="bg-white shadow-xl rounded-xl p-6 md:p-10 mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4" th:text="${review.arTitle}"></h1>
    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600 mb-6 p-4 bg-gray-50 rounded-md">
      <p><i class="fas fa-user mr-2"></i>작성자: <span th:text="${review.authorName}"></span></p>
      <p><i class="fas fa-clock mr-2"></i>작성일: <span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
      <p><i class="fas fa-eye mr-2"></i>조회수: <span th:text="${review.viewCount}"></span></p>
    </div>
    <hr class="my-8"/>
    <div class="prose max-w-none whitespace-pre-wrap" th:text="${review.reviewContent}"></div>
    <div th:if="${review.attachments != null and !review.attachments.isEmpty()}">
      <hr class="my-8"/>
      <div class="mt-8 mb-8">
        <h3 class="text-xl font-semibold mb-4"><i class="fas fa-paperclip mr-2"></i>첨부된 파일</h3>
        <div class="flex flex-wrap gap-4">
          <div th:each="att : ${review.attachments}">
            <a th:href="@{${att.filePath}}" target="_blank">
              <img th:src="@{${att.filePath}}" class="attachment-image"/>
            </a>
          </div>
        </div>
      </div>
    </div>
    <hr class="my-8"/>
    <div class="action-links mt-8">
      <th:block th:if="${currentUserId != null and review.authorUid == currentUserId}">
        <a class="edit-action" th:href="@{/reviews/{arNo}/edit(arNo=${review.arNo})}">수정</a>
        <form th:action="@{/reviews/{arNo}/delete(arNo=${review.arNo})}" method="post" class="inline" onsubmit="return confirm('삭제하시겠습니까?');">
          <button type="submit" class="delete-action">삭제</button>
        </form>
      </th:block>
      <button type="button" id="like-button" class="like-btn"
              th:classappend="${likeStatus?.currentUserLiked} ? 'liked'"
              th:data-ar-no="${review.arNo}" th:data-board-type="${defaultBoardType}">
        <i class="fas fa-heart mr-1"></i>
        <span class="like-button-text" th:text="${likeStatus?.currentUserLiked} ? '좋아요 취소' : '좋아요'"></span>
        (<span id="like-count" th:text="${likeStatus?.totalLikeCount}">0</span>)
      </button>
      <a class="list-action" th:href="@{/reviews}">목록으로</a>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener("DOMContentLoaded", () => {
    const likeButton = document.getElementById("like-button");
    if (!likeButton) return;

    const likeButtonTextSpan = likeButton.querySelector('.like-button-text');
    const likeCountElement = document.getElementById("like-count");

    likeButton.addEventListener("click", () => {
      const reviewId = likeButton.dataset.arNo;
      // boardType은 이제 백엔드 URL에 직접 사용되지 않고, 백엔드 서비스에서 BOARD_TYPE 상수로 사용됩니다.

      // **** URL 수정 및 응답 처리 로직 개선 ****
      fetch(`/reviews/${reviewId}/like`, { // 백엔드 컨트롤러의 실제 URL에 맞춤
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json" // 서버가 JSON을 기대하도록 명시
        }
      })
              .then(res => {
                // 모든 응답이 JSON으로 통일되었으므로, 일단 JSON으로 파싱을 시도
                return res.json().then(data => {
                  // HTTP 상태 코드와 JSON 응답의 'success' 키를 조합하여 처리
                  if (res.status === 401) { // 401 Unauthorized (로그인 필요)
                    alert(data.message || '로그인이 필요합니다.');
                    window.location.href = /*[[@{/login}]]*/ '/login';
                    // Promise 체인 중단
                    return Promise.reject(new Error('로그인 필요'));
                  } else if (!res.ok || !data.success) { // 2xx 성공이 아니거나 JSON 응답에서 success: false인 경우
                    alert(data.message || '오류가 발생했습니다.');
                    // Promise 체인 중단
                    return Promise.reject(new Error(data.message || '좋아요 처리 실패'));
                  }
                  // 성공적인 JSON 응답이면 데이터를 다음 then 블록으로 전달
                  return data;
                });
              })
              .then(responseJson => { // 백엔드에서 통일된 JSON 응답 ({ success: true, data: {...} } 또는 { success: false, message: "..." })
                // 'success' 키가 true일 때만 UI 업데이트 로직 실행
                if (responseJson.success) {
                  // 실제 좋아요 정보는 'data' 키 안에 있습니다.
                  likeCountElement.textContent = responseJson.data.likeCount;
                  if (responseJson.data.liked) {
                    likeButtonTextSpan.textContent = '좋아요 취소';
                    likeButton.classList.add('liked');
                  } else {
                    likeButtonTextSpan.textContent = '좋아요';
                    likeButton.classList.remove('liked');
                  }
                }
                // 'success: false'인 경우는 위에서 이미 alert 띄우고 reject 되었으므로 여기서는 처리할 필요 없음
              })
              .catch(err => {
                // 네트워크 오류나 위에서 throw된 에러를 여기서 잡습니다.
                // '로그인 필요' 에러는 이미 처리했으므로 중복 알림 방지
                if (err.message !== '로그인 필요') {
                  console.error("좋아요 에러:", err);
                  // 사용자에게 친화적인 메시지 제공
                  alert('좋아요 처리 중 예상치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
                }
              });
    });
  });
  /*]]>*/
</script>

</body>
</html>