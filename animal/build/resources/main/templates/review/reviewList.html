<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>입양 후기 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        .action-btn {
            font-size: 0.8rem; padding: 0.2rem 0.4rem; margin: 0 0.1rem;
            border-radius: 0.2rem; color: white; text-decoration: none;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem;
        }
        .edit-btn { background-color: #06b6d4; } /* Tailwind: bg-cyan-500 */
        .edit-btn:hover { background-color: #0891b2; }
        .delete-btn { background-color: #ef4444; } /* Tailwind: bg-red-500 */
        .delete-btn:hover { background-color: #dc2626; }
        .like-btn {
            background-color: #3b82f6; color: white; padding: 0.2rem 0.4rem; font-size: 0.8rem; border-radius: 0.2rem;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem;
        }
        .like-btn.liked { background-color: #ec4899; } /* Tailwind: bg-pink-500 */
        .like-btn:hover { opacity: 0.8; }
        .thumbnail-image { width: 48px; height: 48px; object-fit: cover; border-radius: 0.25rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div th:replace="~{fragments/header :: commonHeader}"></div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-20 sm:pt-24">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">입양 후기 목록</h1>
        <div class="action-button-container">
            <a th:if="${currentUserId != null}" th:href="@{/reviews/new}"
               class="px-4 py-2 bg-green-500 text-white text-sm font-medium rounded-md hover:bg-green-600 shadow-sm">
                <i class="fas fa-pen mr-1"></i>새 후기 작성
            </a>
            <a th:unless="${currentUserId != null}" th:href="@{/login}"
               class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 shadow-sm">
                <i class="fas fa-sign-in-alt mr-1"></i>로그인 후 작성
            </a>
        </div>
    </div>

    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
        <table class="min-w-full">
            <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">번호</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">사진</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">제목</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">작성자</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">작성일</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">조회수</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">좋아요</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">기능</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            <tr th:each="review, stat : ${reviews}" class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-center"
                    th:text="${totalCount - ((pageInfo.currentPage - 1) * pageInfo.size) - stat.index}"></td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <div th:if="${review.attachments != null && !#lists.isEmpty(review.attachments)}" class="flex justify-center">
                        <img th:src="@{'/uploads/' + ${review.attachments[0].filePath}}" alt="대표사진" class="thumbnail-image" />
                    </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-left">
                    <a th:href="@{'/reviews/' + ${review.arNo}}"
                       th:text="${review.arTitle != null ? review.arTitle : '제목 없음'}" class="text-indigo-600 hover:text-indigo-800 font-medium">후기 제목</a>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" th:text="${review.authorName}">작성자 이름</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500"
                    th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy-MM-dd') : ''}">작성일</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" th:text="${review.viewCount ?: 0}">0</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                    <button type="button" class="like-button"
                            th:classappend="${likeStatuses != null && likeStatuses[review.arNo]?.currentUserLiked == true} ? 'liked'"
                            th:attr="data-ar-no=${review.arNo}, data-board-type=${defaultBoardType}">
                        <i class="fas fa-heart mr-1"></i>
                        <span th:text="${likeStatuses != null && likeStatuses[review.arNo]?.totalLikeCount != null ? likeStatuses[review.arNo].totalLikeCount : 0}">0</span>
                    </button>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    <div th:if="${currentUserId != null and review.authorUid == currentUserId}" class="flex justify-center space-x-2">
                        <a th:href="@{/reviews/{arNo}/edit(arNo=${review.arNo})}" class="action-btn edit-btn"><i class="fas fa-edit"></i> 수정</a>
                        <form th:action="@{/reviews/{arNo}/delete(arNo=${review.arNo})}" method="post" class="inline" onsubmit="return confirm('정말로 삭제하시겠습니까?');">
                            <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i> 삭제</button>
                        </form>
                    </div>
                </td>
            </tr>
            <tr th:if="${reviews == null or #lists.isEmpty(reviews)}">
                <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">등록된 후기가 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="mt-6 flex justify-center items-center space-x-1" th:if="${pageInfo != null && pageInfo.totalPages > 1}">
        <a th:if="${pageInfo.currentPage > 1}" th:href="@{|/reviews?page=${pageInfo.currentPage - 1}&size=${pageInfo.size}|}"
           class="px-4 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-md text-sm font-medium">이전</a>
        <a th:unless="${pageInfo.currentPage > 1}"
           class="px-4 py-2 border border-gray-300 bg-gray-50 text-gray-400 rounded-md cursor-not-allowed text-sm font-medium">이전</a>
        <th:block th:each="i : ${#numbers.sequence(1, pageInfo.totalPages)}">
            <a th:if="${i == pageInfo.currentPage}"
               class="px-4 py-2 border border-blue-500 bg-blue-500 text-white rounded-md text-sm font-medium" th:text="${i}"></a>
            <a th:if="${i != pageInfo.currentPage}" th:href="@{|/reviews?page=${i}&size=${pageInfo.size}|}"
               class="px-4 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-md text-sm font-medium" th:text="${i}"></a>
        </th:block>
        <a th:if="${pageInfo.currentPage < pageInfo.totalPages}" th:href="@{|/reviews?page=${pageInfo.currentPage + 1}&size=${pageInfo.size}|}"
           class="px-4 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 rounded-md text-sm font-medium">다음</a>
        <a th:unless="${pageInfo.currentPage < pageInfo.totalPages}"
           class="px-4 py-2 border border-gray-300 bg-gray-50 text-gray-400 rounded-md cursor-not-allowed text-sm font-medium">다음</a>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const defaultBoardTypeForReviewList = /*[[${defaultBoardType}]]*/ 'adoptionReview';

    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.arNo;
            const boardType = this.dataset.boardType || defaultBoardTypeForReviewList;
            const likeButton = this;
            const likeCountSpan = this; // 버튼 전체를 가리키므로, 내부의 숫자만 있는 span을 찾아야 함. 여기서는 버튼 자체의 innerHTML을 변경.

            fetch(`/api/likes/${boardType}/${reviewId}`, {
                method: 'POST',
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
                .then(response => {
                    if (response.status === 401) {
                        alert('로그인이 필요합니다.');
                        window.location.href = /*[[@{/login}]]*/ '/login';
                        throw new Error('로그인 필요');
                    }
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '좋아요 처리 실패'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        likeCountSpan.innerHTML = `<i class="fas fa-heart mr-1"></i> ${data.likeCount}`; // 아이콘과 숫자 함께 업데이트
                        if (data.liked) {
                            likeButton.classList.add('liked');
                        } else {
                            likeButton.classList.remove('liked');
                        }
                    } else {
                        alert(data.message || '좋아요 처리에 실패했습니다.');
                    }
                })
                .catch(error => {
                    if (error.message !== '로그인 필요') {
                        console.error('Like Error:', error);
                        alert(error.message || '오류가 발생했습니다.');
                    }
                });
        });
    });
    /*]]>*/
</script>
</body>
</html>